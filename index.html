<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Easy Apply Jobs</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-gray-50 via-white to-gray-50 min-h-screen font-sans">
<div id="app"></div>

<script>
/* =====================
   STATE
===================== */
const state = {
  jobs: [],
  filteredJobs: [],
  currentJobs: [],
  searchTerm: "",
  locationFilter: "",
  categoryFilter: "",
  categories: [],
  viewMode: "all",
  savedJobs: new Set(),
  currentPage: 1,
  jobsPerPage: 50,
  loading: true,
  error: null
};

/* =====================
   STORAGE (MOBILE SAFE)
===================== */
function loadSavedJobs() {
  try {
    const saved = localStorage.getItem("saved-jobs");
    if (saved) state.savedJobs = new Set(JSON.parse(saved));
  } catch {}
}

function saveSavedJobs() {
  try {
    localStorage.setItem("saved-jobs", JSON.stringify([...state.savedJobs]));
  } catch {}
}

/* =====================
   DATA
===================== */
function getJobId(job) {
  return `${job.Company}-${job["Job Title"]}-${job.Location}`
    .replace(/\s+/g,"-")
    .toLowerCase();
}

/* =====================
   FETCH
===================== */
function fetchJobs() {
  loadSavedJobs();
  fetch("https://raw.githubusercontent.com/easyapplyjobs/easyapplyjobs-data/refs/heads/main/jobs.csv")
    .then(r => r.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: res => {
          state.jobs = res.data.filter(j => j["Job Title"]);
          state.categories = [...new Set(
            state.jobs.map(j => j["Role Category"]).filter(Boolean)
          )].sort();
          state.filteredJobs = state.jobs;
          state.loading = false;
          render();
        }
      });
    })
    .catch(() => {
      state.error = "Failed to load jobs";
      state.loading = false;
      render();
    });
}

/* =====================
   FILTERING
===================== */
function filterJobs() {
  let jobs = state.jobs;

  if (state.viewMode === "saved") {
    jobs = jobs.filter(j => state.savedJobs.has(getJobId(j)));
  }

  if (state.searchTerm) {
    const t = state.searchTerm.toLowerCase();
    jobs = jobs.filter(j =>
      j["Job Title"]?.toLowerCase().includes(t) ||
      j.Company?.toLowerCase().includes(t)
    );
  }

  if (state.locationFilter) {
    const l = state.locationFilter.toLowerCase();
    jobs = jobs.filter(j =>
      j.Location?.toLowerCase().includes(l)
    );
  }

  if (state.categoryFilter) {
    jobs = jobs.filter(j => j["Role Category"] === state.categoryFilter);
  }

  state.filteredJobs = jobs;
  state.currentPage = 1;
  updateCurrentJobs();
}

function updateCurrentJobs() {
  const start = (state.currentPage - 1) * state.jobsPerPage;
  state.currentJobs = state.filteredJobs.slice(start, start + state.jobsPerPage);
  render();
}

/* =====================
   ACTIONS
===================== */
function runSearch() { filterJobs(); }
function setViewMode(mode) { state.viewMode = mode; filterJobs(); }

function toggleSave(job) {
  const id = getJobId(job);
  state.savedJobs.has(id) ? state.savedJobs.delete(id) : state.savedJobs.add(id);
  saveSavedJobs();
  render();
}

/* =====================
   RENDER
===================== */
function render() {
  const app = document.getElementById("app");

  if (state.loading) {
    app.innerHTML = `<div class="min-h-screen flex items-center justify-center text-gray-600">Loading jobsâ€¦</div>`;
    return;
  }

  if (state.error) {
    app.innerHTML = `<div class="p-10 text-center text-red-600">${state.error}</div>`;
    return;
  }

  app.innerHTML = `
  <div class="bg-white sticky top-0 z-40 border-b">
    <div class="max-w-6xl mx-auto p-4">
      <h1 class="text-3xl font-bold text-[#075A57] mb-4">Easy Apply Jobs</h1>

      <div class="flex gap-2 mb-4">
        <button id="allJobsBtn" class="px-4 py-2 rounded ${state.viewMode==="all"?"bg-[#00917C] text-white":"bg-gray-100"}">All Jobs</button>
        <button id="savedJobsBtn" class="px-4 py-2 rounded ${state.viewMode==="saved"?"bg-[#00917C] text-white":"bg-gray-100"}">
          Saved (${state.savedJobs.size})
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="searchInput" class="border rounded px-4 py-3" placeholder="Job title or company"/>
        <input id="locationInput" class="border rounded px-4 py-3" placeholder="Location"/>
        <button id="searchBtn" class="bg-[#00917C] text-white rounded px-6 py-3 hover:bg-[#075A57]">Search Jobs</button>
      </div>

      <div class="mt-3">
        <select id="categorySelect" class="border rounded px-4 py-2">
          <option value="">All Categories</option>
          ${state.categories.map(c => `<option>${c}</option>`).join("")}
        </select>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto p-4">
    ${state.currentJobs.length === 0 ? `
      <div class="text-center text-gray-500 py-20">No jobs to display</div>
    ` : `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${state.currentJobs.map(j => `
          <div class="bg-white border rounded p-4">
            <div class="font-semibold">${j["Job Title"]}</div>
            <div class="text-[#00917C]">${j.Company}</div>
            <div class="text-sm text-gray-500">${j.Location || ""}</div>
            <button data-id="${getJobId(j)}" class="saveBtn mt-2 text-sm text-[#00917C]">
              ${state.savedJobs.has(getJobId(j)) ? "Unsave" : "Save"}
            </button>
          </div>
        `).join("")}
      </div>
    `}
  </div>
  `;

  bindEvents();
}

/* =====================
   EVENTS (SAFARI SAFE)
===================== */
function bindEvents() {
  document.getElementById("allJobsBtn")?.addEventListener("click", () => setViewMode("all"));
  document.getElementById("savedJobsBtn")?.addEventListener("click", () => setViewMode("saved"));

  document.getElementById("searchInput")?.addEventListener("input", e => state.searchTerm = e.target.value);
  document.getElementById("locationInput")?.addEventListener("input", e => state.locationFilter = e.target.value);

  document.getElementById("searchBtn")?.addEventListener("click", runSearch);
  document.getElementById("categorySelect")?.addEventListener("change", e => {
    state.categoryFilter = e.target.value;
    filterJobs();
  });

  document.querySelectorAll(".saveBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const job = state.jobs.find(j => getJobId(j) === btn.dataset.id);
      if (job) toggleSave(job);
    });
  });
}

fetchJobs();
</script>
</body>
</html>
